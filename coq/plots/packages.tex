\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{gnuplottex}[2016/08/21]%must be before listings package; min date is for compat with tikzexternalize
\usepackage{pgfkeys}
\usepackage{pgfplotstable}
\pgfplotsset{compat=1.15}
\usepackage{currfile}
\usepackage{filecontents}

\usepgfplotslibrary{external}
\tikzexternalize
\tikzsetfigurename{\tikzexternalrealjob-\currfilebase-figure}

\usepackage{hyperref}
\usepackage{unicode-math}
\usepackage{amsmath}
\usepackage{newunicodechar}
\newcommand{\newunicodecharpdftex}[2]{\newunicodechar{#1}{\texorpdfstring{#2}{#1}}}
\newunicodecharpdftex{Œë}{\ensuremath{\Alpha}}
\newunicodecharpdftex{Œí}{\ensuremath{\Beta}}
\newunicodecharpdftex{Œì}{\ensuremath{\Gamma}}
\newunicodecharpdftex{Œî}{\ensuremath{\Delta}}
\newunicodecharpdftex{Œï}{\ensuremath{\Epsilon}}
\newunicodecharpdftex{Œñ}{\ensuremath{\Zeta}}
\newunicodecharpdftex{Œó}{\ensuremath{\Eta}}
\newunicodecharpdftex{Œò}{\ensuremath{\Theta}}
\newunicodecharpdftex{Œô}{\ensuremath{\Iota}}
\newunicodecharpdftex{Œö}{\ensuremath{\Kappa}}
\newunicodecharpdftex{Œõ}{\ensuremath{\Lambda}}
\newunicodecharpdftex{Œú}{\ensuremath{\Mu}}
\newunicodecharpdftex{Œù}{\ensuremath{\Nu}}
\newunicodecharpdftex{Œû}{\ensuremath{\Xi}}
\newunicodecharpdftex{Œü}{\ensuremath{\Omicron}}
\newunicodecharpdftex{Œ†}{\ensuremath{\Pi}}
\newunicodecharpdftex{Œ°}{\ensuremath{\Rho}}
\newunicodecharpdftex{Œ£}{\ensuremath{\Sigma}}
\newunicodecharpdftex{Œ§}{\ensuremath{\Tau}}
\newunicodecharpdftex{Œ•}{\ensuremath{\Upsilon}}
\newunicodecharpdftex{Œ¶}{\ensuremath{\Phi}}
\newunicodecharpdftex{Œß}{\ensuremath{\Chi}}
\newunicodecharpdftex{Œ®}{\ensuremath{\Psi}}
\newunicodecharpdftex{Œ©}{\ensuremath{\Omega}}
\newunicodecharpdftex{Œ±}{\ensuremath{\alpha}}
\newunicodecharpdftex{Œ≤}{\ensuremath{\beta}}
\newunicodecharpdftex{Œ≥}{\ensuremath{\gamma}}
\newunicodecharpdftex{Œ¥}{\ensuremath{\delta}}
\newunicodecharpdftex{œµ}{\ensuremath{\epsilon}}
\newunicodecharpdftex{Œµ}{\ensuremath{\varepsilon}}
\newunicodecharpdftex{Œ∂}{\ensuremath{\zeta}}
\newunicodecharpdftex{Œ∑}{\ensuremath{\eta}}
\newunicodecharpdftex{Œ∏}{\ensuremath{\theta}}
\newunicodecharpdftex{œë}{\ensuremath{\vartheta}}
\newunicodecharpdftex{Œπ}{\ensuremath{\iota}}
\newunicodecharpdftex{Œ∫}{\ensuremath{\kappa}}
\newunicodecharpdftex{œ∞}{\ensuremath{\varkappa}}
\newunicodecharpdftex{Œª}{\ensuremath{\lambda}}
\newunicodecharpdftex{Œº}{\ensuremath{\mu}}
\newunicodecharpdftex{ŒΩ}{\ensuremath{\nu}}
\newunicodecharpdftex{Œæ}{\ensuremath{\xi}}
\newunicodecharpdftex{Œø}{\ensuremath{\omicron}}
\newunicodecharpdftex{œÄ}{\ensuremath{\pi}}
\newunicodecharpdftex{œñ}{\ensuremath{\varpi}}
\newunicodecharpdftex{œÅ}{\ensuremath{\rho}}
\newunicodecharpdftex{œ±}{\ensuremath{\varrho}}
\newunicodecharpdftex{œÉ}{\ensuremath{\sigma}}
\newunicodecharpdftex{œÇ}{\ensuremath{\varsigma}}
\newunicodecharpdftex{œÑ}{\ensuremath{\tau}}
\newunicodecharpdftex{œÖ}{\ensuremath{\upsilon}}
\newunicodecharpdftex{œï}{\ensuremath{\phi}}
\newunicodecharpdftex{œÜ}{\ensuremath{\varphi}}
\newunicodecharpdftex{œá}{\ensuremath{\chi}}
\newunicodecharpdftex{œà}{\ensuremath{\psi}}
\newunicodecharpdftex{œâ}{\ensuremath{\omega}}
\newunicodecharpdftex{‚àÄ}{\ensuremath{\forall}}
\newunicodecharpdftex{‚àÉ}{\ensuremath{\exists}}
\newunicodecharpdftex{‚Üí}{\ensuremath{\to}}
\newunicodecharpdftex{‚áí}{\ensuremath{\Rightarrow}}
\newunicodecharpdftex{√ó}{\ensuremath{\times}}
\newunicodecharpdftex{‚àß}{\ensuremath{\wedge}}
\newunicodecharpdftex{‚ä¢}{\ensuremath{\vdash}}
\newunicodecharpdftex{ùîπ}{\ensuremath{\mathbb{B}}}
\newunicodecharpdftex{‚ÑÇ}{\ensuremath{\mathbb{C}}}
\newunicodecharpdftex{‚Ñï}{\ensuremath{\mathbb{N}}}
\newunicodecharpdftex{‚Ñô}{\ensuremath{\mathbb{P}}}
\newunicodecharpdftex{‚Ñö}{\ensuremath{\mathbb{Q}}}
\newunicodecharpdftex{‚Ñù}{\ensuremath{\mathbb{R}}}
\newunicodecharpdftex{‚Ñ§}{\ensuremath{\mathbb{Z}}}
\newunicodecharpdftex{‚Å∞}{\ensuremath{{}^0}}
\newunicodecharpdftex{¬π}{\ensuremath{{}^1}}
\newunicodecharpdftex{¬≤}{\ensuremath{{}^2}}
\newunicodecharpdftex{¬≥}{\ensuremath{{}^3}}
\newunicodecharpdftex{‚Å¥}{\ensuremath{{}^4}}
\newunicodecharpdftex{‚Åµ}{\ensuremath{{}^5}}
\newunicodecharpdftex{‚Å∂}{\ensuremath{{}^6}}
\newunicodecharpdftex{‚Å∑}{\ensuremath{{}^7}}
\newunicodecharpdftex{‚Å∏}{\ensuremath{{}^8}}
\newunicodecharpdftex{‚Åπ}{\ensuremath{{}^9}}
\newunicodecharpdftex{‚ÇÄ}{\ensuremath{{}_0}}
\newunicodecharpdftex{‚ÇÅ}{\ensuremath{{}_1}}
\newunicodecharpdftex{‚ÇÇ}{\ensuremath{{}_2}}
\newunicodecharpdftex{‚ÇÉ}{\ensuremath{{}_3}}
\newunicodecharpdftex{‚ÇÑ}{\ensuremath{{}_4}}
\newunicodecharpdftex{‚ÇÖ}{\ensuremath{{}_5}}
\newunicodecharpdftex{‚ÇÜ}{\ensuremath{{}_6}}
\newunicodecharpdftex{‚Çá}{\ensuremath{{}_7}}
\newunicodecharpdftex{‚Çà}{\ensuremath{{}_8}}
\newunicodecharpdftex{‚Çâ}{\ensuremath{{}_9}}
\newunicodecharpdftex{‚Å∫}{\ensuremath{{}^+}}
\newunicodecharpdftex{‚Åª}{\ensuremath{{}^-}}
\newunicodecharpdftex{‚Åº}{\ensuremath{{}^=}}
\newunicodecharpdftex{‚ÅΩ}{\ensuremath{{}^(}}
\newunicodecharpdftex{‚Åæ}{\ensuremath{{}^)}}
\newunicodecharpdftex{‚Çä}{\ensuremath{{}_+}}
\newunicodecharpdftex{‚Çã}{\ensuremath{{}_-}}
\newunicodecharpdftex{‚Çå}{\ensuremath{{}_=}}
\newunicodecharpdftex{‚Çç}{\ensuremath{{}_(}}
\newunicodecharpdftex{‚Çé}{\ensuremath{{}_)}}

\newunicodecharpdftex{·µÉ}{\ensuremath{{}^{\text{a}}}}
\newunicodecharpdftex{·µá}{\ensuremath{{}^{\text{b}}}}
\newunicodecharpdftex{·∂ú}{\ensuremath{{}^{\text{c}}}}
\newunicodecharpdftex{·µà}{\ensuremath{{}^{\text{d}}}}
\newunicodecharpdftex{·µâ}{\ensuremath{{}^{\text{e}}}}
\newunicodecharpdftex{·∂†}{\ensuremath{{}^{\text{f}}}}
\newunicodecharpdftex{·µç}{\ensuremath{{}^{\text{g}}}}
\newunicodecharpdftex{ ∞}{\ensuremath{{}^{\text{h}}}}
\newunicodecharpdftex{‚Å±}{\ensuremath{{}^{\text{i}}}}
\newunicodecharpdftex{ ≤}{\ensuremath{{}^{\text{j}}}}
\newunicodecharpdftex{·µè}{\ensuremath{{}^{\text{k}}}}
\newunicodecharpdftex{À°}{\ensuremath{{}^{\text{l}}}}
\newunicodecharpdftex{·µê}{\ensuremath{{}^{\text{m}}}}
\newunicodecharpdftex{‚Åø}{\ensuremath{{}^{\text{n}}}}
\newunicodecharpdftex{·µí}{\ensuremath{{}^{\text{o}}}}
\newunicodecharpdftex{·µñ}{\ensuremath{{}^{\text{p}}}}
\newunicodecharpdftex{ ≥}{\ensuremath{{}^{\text{r}}}}
\newunicodecharpdftex{À¢}{\ensuremath{{}^{\text{s}}}}
\newunicodecharpdftex{·µó}{\ensuremath{{}^{\text{t}}}}
\newunicodecharpdftex{·µò}{\ensuremath{{}^{\text{u}}}}
\newunicodecharpdftex{·µõ}{\ensuremath{{}^{\text{v}}}}
\newunicodecharpdftex{ ∑}{\ensuremath{{}^{\text{w}}}}
\newunicodecharpdftex{À£}{\ensuremath{{}^{\text{x}}}}
\newunicodecharpdftex{ ∏}{\ensuremath{{}^{\text{y}}}}
\newunicodecharpdftex{·∂ª}{\ensuremath{{}^{\text{z}}}}
\newunicodecharpdftex{‚Çê}{\ensuremath{{}_{\text{a}}}}
\newunicodecharpdftex{‚Çë}{\ensuremath{{}_{\text{e}}}}
\newunicodecharpdftex{‚Çï}{\ensuremath{{}_{\text{h}}}}
\newunicodecharpdftex{·µ¢}{\ensuremath{{}_{\text{i}}}}
\newunicodecharpdftex{‚±º}{\ensuremath{{}_{\text{j}}}}
\newunicodecharpdftex{‚Çñ}{\ensuremath{{}_{\text{k}}}}
\newunicodecharpdftex{‚Çó}{\ensuremath{{}_{\text{l}}}}
\newunicodecharpdftex{‚Çò}{\ensuremath{{}_{\text{m}}}}
\newunicodecharpdftex{‚Çô}{\ensuremath{{}_{\text{n}}}}
\newunicodecharpdftex{‚Çí}{\ensuremath{{}_{\text{o}}}}
\newunicodecharpdftex{‚Çö}{\ensuremath{{}_{\text{p}}}}
\newunicodecharpdftex{·µ£}{\ensuremath{{}_{\text{r}}}}
\newunicodecharpdftex{‚Çõ}{\ensuremath{{}_{\text{s}}}}
\newunicodecharpdftex{‚Çú}{\ensuremath{{}_{\text{t}}}}
\newunicodecharpdftex{·µ§}{\ensuremath{{}_{\text{u}}}}
\newunicodecharpdftex{·µ•}{\ensuremath{{}_{\text{v}}}}
\newunicodecharpdftex{‚Çì}{\ensuremath{{}_{\text{x}}}}

\newunicodecharpdftex{‚âÖ}{\ensuremath{\cong}}
\newunicodecharpdftex{‚àò}{\ensuremath{\circ}}


% to have the external picture be updated every time the input files are changed
\makeatletter
\newcommand{\einput}[1]{\@@input #1 \space}
\newcommand{\beginTikzpictureStamped}[2][]{%
    {%
        \everyeof{\noexpand}% IDK why \noexpand is the magic one, but I got it from http://mirrors.ibiblio.org/CTAN/macros/latex/contrib/oberdiek/catchfile.pdf
        \long\xdef\@tikzstamp{#2}%
    }%
    \def\@dobegintikzpicture{\begin{tikzpicture}[#1]}%
    \expandafter\@dobegintikzpicture\expandafter\def\expandafter\tikzstamp\expandafter{\@tikzstamp}%
}
\newcommand{\TikzpictureStamped}[3][]{\beginTikzpictureStamped[#1]{#2}#3\end{tikzpicture}}%
\makeatother


\usepackage{xstring} % for \IfStrEq, \IfInteger

%% exponential regression fit
\makeatletter
% https://tex.stackexchange.com/a/50113/2066
\newcommand*{\IsInteger}[3]{%
    \IfStrEq{#1}{ }{%
        #3% is a blank string
    }{%
    \IfInteger{#1}{#2}{#3}%
}%
}%
\newcommand{\pgftognucolumnset}[2]{%
    \IsInteger{\pgfkeysvalueof{#1}}{%
        % pgf 0-indexes columns, while gnuplot 1-indexes columns, so we add 1 to adjust
        \edef#2{\the\numexpr\pgfkeysvalueof{#1}+1\relax}%
    }{%
    \edef#2{(column("\pgfkeysvalueof{#1}"))}%
}%
}
\makeatletter
% \addplotexponentialregression[params for \addplot][default settings for a and b, also for x and y columns]{table file}
\NewDocumentCommand{\addplotexponentialregression}{ O{no markers} o m}{%
    \pgfkeyssetvalue{/addplotexponentialregression/x}{0}
    \pgfkeyssetvalue{/addplotexponentialregression/y}{1}
    \pgfkeyssetvalue{/addplotexponentialregression/a}{1}
    \pgfkeyssetvalue{/addplotexponentialregression/b}{1}
    \pgfkeys{/addplotexponentialregression/.cd,#2}
    \pgftognucolumnset{/addplotexponentialregression/x}{\@addplotexponentialregression@colx}%
    \pgftognucolumnset{/addplotexponentialregression/y}{\@addplotexponentialregression@coly}%
    \edef\@addplotexponentialregression@inita{\pgfkeysvalueof{/addplotexponentialregression/a}}%
    \edef\@addplotexponentialregression@initb{\pgfkeysvalueof{/addplotexponentialregression/b}}%
    \addplot [#1] gnuplot [raw gnuplot] { % allows arbitrary gnuplot commands
        f(x) = a*exp(b*x);     % Define the function to fit
        % Set reasonable starting values here
        a=\@addplotexponentialregression@inita;
        b=\@addplotexponentialregression@initb;
        fit f(x) '#3' u \@addplotexponentialregression@colx:\@addplotexponentialregression@coly\space via a,b; % Select the file
        stats '#3' u \@addplotexponentialregression@colx;
        plot [x=STATS_min:STATS_max] f(x);    % Specify the range to plot
        set print "#3-parameters.dat";  % Open a file to save the parameters
        print a, b;                  % Write the parameters to file
    };
    \pgfplotstableread{#3-parameters.dat}\parameters % Open the file Gnuplot wrote
    \pgfplotstablegetelem{0}{0}\of\parameters \xdef\pgfplotstableregressiona{\pgfplotsretval} % Get first element, save into \pgfplotstableregressiona
    \pgfplotstablegetelem{0}{1}\of\parameters \xdef\pgfplotstableregressionb{\pgfplotsretval}
}
% \addplotquadraticregression[params for \addplot][default settings for a and b and c, also for x and y columns]{table file}
\NewDocumentCommand{\addplotquadraticregression}{ O{no markers} o m}{%
    \pgfkeyssetvalue{/addplotquadraticregression/x}{0}
    \pgfkeyssetvalue{/addplotquadraticregression/y}{1}
    \pgfkeyssetvalue{/addplotquadraticregression/a}{1}
    \pgfkeyssetvalue{/addplotquadraticregression/b}{1}
    \pgfkeyssetvalue{/addplotquadraticregression/c}{1}
    \pgfkeys{/addplotquadraticregression/.cd,#2}
    \pgftognucolumnset{/addplotquadraticregression/x}{\@addplotquadraticregression@colx}%
    \pgftognucolumnset{/addplotquadraticregression/y}{\@addplotquadraticregression@coly}%
    \edef\@addplotquadraticregression@inita{\pgfkeysvalueof{/addplotquadraticregression/a}}%
    \edef\@addplotquadraticregression@initb{\pgfkeysvalueof{/addplotquadraticregression/b}}%
    \edef\@addplotquadraticregression@initc{\pgfkeysvalueof{/addplotquadraticregression/c}}%
    \addplot [#1] gnuplot [raw gnuplot] { % allows arbitrary gnuplot commands
        f(x) = a*x**2+b*x+c;     % Define the function to fit
        % Set reasonable starting values here
        a=\@addplotquadraticregression@inita;
        b=\@addplotquadraticregression@initb;
        c=\@addplotquadraticregression@initc;
        fit f(x) '#3' u \@addplotquadraticregression@colx:\@addplotquadraticregression@coly\space via a,b,c; % Select the file
        stats '#3' u \@addplotquadraticregression@colx;
        plot [x=STATS_min:STATS_max] f(x);    % Specify the range to plot
        set print "#3-parameters.dat";  % Open a file to save the parameters
        print a, b, c;                  % Write the parameters to file
    };
    \pgfplotstableread{#3-parameters.dat}\parameters % Open the file Gnuplot wrote
    \pgfplotstablegetelem{0}{0}\of\parameters \xdef\pgfplotstableregressiona{\pgfplotsretval} % Get first element, save into \pgfplotstableregressiona
    \pgfplotstablegetelem{0}{1}\of\parameters \xdef\pgfplotstableregressionb{\pgfplotsretval}
    \pgfplotstablegetelem{0}{2}\of\parameters \xdef\pgfplotstableregressionc{\pgfplotsretval}
}
% \addplotcubicregression[params for \addplot][default settings for a and b and c and d, also for x and y columns]{table file}
\NewDocumentCommand{\addplotcubicregression}{ O{no markers} o m}{%
    \pgfkeyssetvalue{/addplotcubicregression/x}{0}
    \pgfkeyssetvalue{/addplotcubicregression/y}{1}
    \pgfkeyssetvalue{/addplotcubicregression/a}{1}
    \pgfkeyssetvalue{/addplotcubicregression/b}{1}
    \pgfkeyssetvalue{/addplotcubicregression/c}{1}
    \pgfkeyssetvalue{/addplotcubicregression/d}{1}
    \pgfkeys{/addplotcubicregression/.cd,#2}
    \pgftognucolumnset{/addplotcubicregression/x}{\@addplotcubicregression@colx}%
    \pgftognucolumnset{/addplotcubicregression/y}{\@addplotcubicregression@coly}%
    \edef\@addplotcubicregression@inita{\pgfkeysvalueof{/addplotcubicregression/a}}%
    \edef\@addplotcubicregression@initb{\pgfkeysvalueof{/addplotcubicregression/b}}%
    \edef\@addplotcubicregression@initc{\pgfkeysvalueof{/addplotcubicregression/c}}%
    \edef\@addplotcubicregression@initd{\pgfkeysvalueof{/addplotcubicregression/d}}%
    \addplot [#1] gnuplot [raw gnuplot] { % allows arbitrary gnuplot commands
        f(x) = a*x**3+b*x**2+c*x+d;     % Define the function to fit
        % Set reasonable starting values here
        a=\@addplotcubicregression@inita;
        b=\@addplotcubicregression@initb;
        c=\@addplotcubicregression@initc;
        d=\@addplotcubicregression@initd;
        fit f(x) '#3' u \@addplotcubicregression@colx:\@addplotcubicregression@coly\space via a,b,c,d; % Select the file
        stats '#3' u \@addplotcubicregression@colx;
        plot [x=STATS_min:STATS_max] f(x);    % Specify the range to plot
        set print "#3-parameters.dat";  % Open a file to save the parameters
        print a, b, c, d;                  % Write the parameters to file
    };
    \pgfplotstableread{#3-parameters.dat}\parameters % Open the file Gnuplot wrote
    \pgfplotstablegetelem{0}{0}\of\parameters \xdef\pgfplotstableregressiona{\pgfplotsretval} % Get first element, save into \pgfplotstableregressiona
    \pgfplotstablegetelem{0}{1}\of\parameters \xdef\pgfplotstableregressionb{\pgfplotsretval}
    \pgfplotstablegetelem{0}{2}\of\parameters \xdef\pgfplotstableregressionc{\pgfplotsretval}
    \pgfplotstablegetelem{0}{3}\of\parameters \xdef\pgfplotstableregressiond{\pgfplotsretval}
}
% regress on y = a (x!)
% \addplotfactorialregression[params for \addplot][default settings for a, also for x and y columns]{table file}
\NewDocumentCommand{\addplotfactorialregression}{ O{no markers} o m}{%
    \pgfkeyssetvalue{/addplotquadraticregression/x}{0}
    \pgfkeyssetvalue{/addplotquadraticregression/y}{1}
    \pgfkeyssetvalue{/addplotquadraticregression/a}{1}
    \pgfkeys{/addplotquadraticregression/.cd,#2}
    \pgftognucolumnset{/addplotquadraticregression/x}{\@addplotquadraticregression@colx}%
    \pgftognucolumnset{/addplotquadraticregression/y}{\@addplotquadraticregression@coly}%
    \edef\@addplotquadraticregression@inita{\pgfkeysvalueof{/addplotquadraticregression/a}}%
    \addplot [#1] gnuplot [raw gnuplot] { % allows arbitrary gnuplot commands
        f(x) = a*gamma(x+1);     % Define the function to fit
        % Set reasonable starting values here
        a=\@addplotquadraticregression@inita;
        fit f(x) '#3' u \@addplotquadraticregression@colx:\@addplotquadraticregression@coly\space via a; % Select the file
        stats '#3' u \@addplotquadraticregression@colx;
        plot [x=STATS_min:STATS_max] f(x);    % Specify the range to plot
        set print "#3-parameters.dat";  % Open a file to save the parameters
        print a;                  % Write the parameters to file
    };
    \pgfplotstableread{#3-parameters.dat}\parameters % Open the file Gnuplot wrote
    \pgfplotstablegetelem{0}{0}\of\parameters \xdef\pgfplotstableregressiona{\pgfplotsretval} % Get first element, save into \pgfplotstableregressiona
}
\makeatother
